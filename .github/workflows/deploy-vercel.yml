name: Vercel Deployment
# on:
#   push:
#     branches:
#       - main
#   pull_request:
on:
  push:
concurrency:
  group: deploy-vercel-${{ github.ref }}
  cancel-in-progress: true
env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'preview' }}
jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      git-branch: ${{ steps.get-branch.outputs.branch }}
    steps:
      - uses: actions/checkout@v3
      - name: Get branch
        id: get-branch
        run: |
          echo "github.event_name = ${{ github.event_name }}"
          echo "github.ref = ${{ github.ref }}"
          echo "github.event.ref = ${{ github.event.ref }}"

          # If the event is delete, use the event ref
          if [ "${{ github.event_name }}" = delete ]; then
            GitRef="${{ github.event.ref }}"
          elif [ "${{ github.event_name }}" = pull_request ]; then
            GitRef="${{ github.head_ref }}"
          else
            GitRef="${{ github.ref }}"
          fi
          GitBranch=$(echo ${GitRef#refs/heads/})

          echo "Git Ref: $GitRef"
          echo "Git Branch Name: $GitBranch"

          echo "::set-output name=branch::$GitBranch"

  deploy:
    name: Deploy (${{ matrix.apps.name }})
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        apps:
        - name: SaaS
          dir: saas
          vercel-project-secret-name: VERCEL_PROJECT_ID_SAAS
        - name: V8
          dir: media
          vercel-project-secret-name: VERCEL_PROJECT_ID_MEDIA
    env:
      VERCEL_PROJECT_ID: ${{ secrets[matrix.apps.vercel-project-secret-name] }}
      NEXT_PUBLIC_SAAS_ACCOUNT_ID: ${{ needs.prepare.outputs.git-branch }}
    steps:
      - uses: actions/checkout@v3
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=${{ env.VERCEL_ENVIRONMENT }} --token=${{ secrets.VERCEL_TOKEN }}
      - name: Development Build
        if: github.ref != 'refs/heads/main'
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
      - name: Production build
        if: github.ref == 'refs/heads/main'
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
      - name: Deploy to Vercel
        run: vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}

  ingestor:
    name: Content Ingestor (${{ matrix.apps.name }})
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        apps:
        - name: SaaS
          vercel-project-secret-name: VERCEL_PROJECT_ID_SAAS
        - name: V8
          vercel-project-secret-name: VERCEL_PROJECT_ID_MEDIA
    env:
      VERCEL_PROJECT_ID: ${{ secrets[matrix.apps.vercel-project-secret-name] }}
    steps:
      - uses: actions/checkout@v3
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      # We're using the environment variables stored on Vercel. So we fetch and then use dotenv to output them into the runner
      - name: Pull Vercel Environment Information
        run: vercel env pull --yes --environment=${{ env.VERCEL_ENVIRONMENT }} --token=${{ secrets.VERCEL_TOKEN }}
      - id: dotenv
        uses: falti/dotenv-action@v1.0.1
      - uses: ./.github/actions/run-ingestor
        with:
          airtable-api-key: ${{ steps.dotenv.outputs.airtable_api_key }}
          airtable-base-id: ${{ steps.dotenv.outputs.airtable_base_id }}
          skylark-api-url: ${{ matrix.apps.name == 'SaaS' && steps.dotenv.outputs.next_public_saas_api_endpoint || steps.dotenv.outputs.next_public_skylark_api_url }}
          cognito-aws-region: ${{ steps.dotenv.outputs.cognito_aws_region }}
          cognito-client-id: ${{ steps.dotenv.outputs.cognito_client_id }}
          cognito-user-pool-id: ${{ steps.dotenv.outputs.cognito_user_pool_id }}
          cognito-identity-pool-id: ${{ steps.dotenv.outputs.cognito_identity_pool_id }}
          amplify-storage-bucket: ${{ steps.dotenv.outputs.amplify_storage_bucket }}
          cognito-email: ${{ steps.dotenv.outputs.cognito_email }}
          cognito-password: ${{ steps.dotenv.outputs.cognito_password }}
          create-additional-objects: "true"
          saas-ingest: ${{ matrix.apps.name == 'SaaS' && 'true' || 'false' }}
          saas-api-token: ${{ steps.dotenv.outputs.next_public_saas_api_key }}
          saas-account-id: ${{ needs.prepare.outputs.git-branch }}
